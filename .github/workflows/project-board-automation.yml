name: Project Board Automation

on:
  issues:
    types: [opened, reopened, labeled, unlabeled, closed]
  pull_request:
    types: [opened, reopened, ready_for_review, converted_to_draft, labeled, unlabeled, closed]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  add-to-board:
    name: Add new issue/PR to pyfolds-board
    runs-on: ubuntu-latest
    if: >-
      (github.event_name == 'issues' && contains(fromJson('["opened","reopened"]'), github.event.action)) ||
      (github.event_name == 'pull_request' && contains(fromJson('["opened","reopened"]'), github.event.action))
    steps:
      - name: Add card to project
        uses: actions/add-to-project@v1.0.2
        with:
          project-url: ${{ secrets.PYFOLDS_BOARD_URL }}
          github-token: ${{ secrets.PROJECTS_TOKEN }}

      - name: Move to Backlog/To-Do
        uses: actions/github-script@v7
        env:
          PROJECT_URL: ${{ secrets.PYFOLDS_BOARD_URL }}
          TARGET_STATUS: Backlog/To-Do
        with:
          github-token: ${{ secrets.PROJECTS_TOKEN }}
          script: |
            const projectUrl = process.env.PROJECT_URL;
            const targetStatus = process.env.TARGET_STATUS;
            const contentId = context.payload.issue?.node_id || context.payload.pull_request?.node_id;
            if (!projectUrl || !contentId) {
              core.setFailed('PROJECT_URL ou contentId ausente.');
              return;
            }

            const numberMatch = projectUrl.match(/projects\/(\d+)/);
            if (!numberMatch) {
              core.setFailed(`Não foi possível extrair número do projeto em: ${projectUrl}`);
              return;
            }

            const owner = projectUrl.split('/')[4];
            const projectNumber = Number(numberMatch[1]);

            const query = `
              query($owner: String!, $number: Int!) {
                organization(login: $owner) {
                  projectV2(number: $number) {
                    id
                    items(first: 100) {
                      nodes {
                        id
                        content {
                          ... on Issue { id }
                          ... on PullRequest { id }
                        }
                      }
                    }
                    field(name: "Status") {
                      ... on ProjectV2SingleSelectField {
                        id
                        options { id name }
                      }
                    }
                  }
                }
                user(login: $owner) {
                  projectV2(number: $number) {
                    id
                    items(first: 100) {
                      nodes {
                        id
                        content {
                          ... on Issue { id }
                          ... on PullRequest { id }
                        }
                      }
                    }
                    field(name: "Status") {
                      ... on ProjectV2SingleSelectField {
                        id
                        options { id name }
                      }
                    }
                  }
                }
              }
            `;

            const res = await github.graphql(query, { owner, number: projectNumber });
            const project = res.organization?.projectV2 || res.user?.projectV2;
            if (!project) {
              core.setFailed('Projeto não encontrado via GraphQL.');
              return;
            }

            const item = project.items.nodes.find((node) => node.content?.id === contentId);
            if (!item) {
              core.warning('Item ainda não indexado no projeto.');
              return;
            }

            const option = project.field.options.find((opt) => opt.name.toLowerCase() === targetStatus.toLowerCase());
            if (!option) {
              core.setFailed(`Status '${targetStatus}' não encontrado.`);
              return;
            }

            await github.graphql(`
              mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                updateProjectV2ItemFieldValue(
                  input: {
                    projectId: $projectId,
                    itemId: $itemId,
                    fieldId: $fieldId,
                    value: { singleSelectOptionId: $optionId }
                  }
                ) {
                  projectV2Item { id }
                }
              }
            `, {
              projectId: project.id,
              itemId: item.id,
              fieldId: project.field.id,
              optionId: option.id,
            });

  move-by-status:
    name: Move card by issue/PR status
    runs-on: ubuntu-latest
    steps:
      - name: Resolve and update project status
        uses: actions/github-script@v7
        env:
          PROJECT_URL: ${{ secrets.PYFOLDS_BOARD_URL }}
        with:
          github-token: ${{ secrets.PROJECTS_TOKEN }}
          script: |
            const projectUrl = process.env.PROJECT_URL;
            if (!projectUrl) {
              core.setFailed('Segredo PYFOLDS_BOARD_URL não configurado.');
              return;
            }

            const numberMatch = projectUrl.match(/projects\/(\d+)/);
            if (!numberMatch) {
              core.setFailed(`Não foi possível extrair número do projeto em: ${projectUrl}`);
              return;
            }

            const owner = projectUrl.split('/')[4];
            const projectNumber = Number(numberMatch[1]);
            const labels = (context.payload.issue?.labels || context.payload.pull_request?.labels || []).map((l) => l.name.toLowerCase());
            const isIssue = context.eventName === 'issues';
            const isPr = context.eventName === 'pull_request';
            const action = context.payload.action;
            const issueState = context.payload.issue?.state;
            const pr = context.payload.pull_request;
            const contentId = context.payload.issue?.node_id || pr?.node_id;

            let targetStatus = null;
            if (isIssue) {
              if (action === 'opened' || action === 'reopened') targetStatus = 'Backlog/To-Do';
              if (labels.includes('blocked')) targetStatus = 'Review/Blocked';
              else if (labels.includes('in progress')) targetStatus = 'In Progress';
              if (action === 'closed' && issueState === 'closed') {
                if (labels.includes('execution:done') && labels.includes('hub:sync')) {
                  targetStatus = 'Done';
                } else {
                  targetStatus = 'Review/Blocked';
                }
              }
            }

            if (isPr) {
              if (action === 'opened' || action === 'reopened') targetStatus = 'Review/Blocked';
              if (action === 'converted_to_draft') targetStatus = 'Review/Blocked';
              if (action === 'ready_for_review') targetStatus = 'Review/Blocked';
              if (labels.includes('blocked')) targetStatus = 'Review/Blocked';
              if (labels.includes('in progress')) targetStatus = 'In Progress';
              if (action === 'closed' && pr?.merged) {
                if (labels.includes('execution:done') && labels.includes('hub:sync')) {
                  targetStatus = 'Done';
                } else {
                  targetStatus = 'Review/Blocked';
                }
              }
            }

            if (!targetStatus || !contentId) {
              core.info('Nenhuma mudança de status aplicável para este evento.');
              return;
            }

            const query = `
              query($owner: String!, $number: Int!) {
                organization(login: $owner) {
                  projectV2(number: $number) {
                    id
                    items(first: 100) {
                      nodes {
                        id
                        content {
                          ... on Issue { id }
                          ... on PullRequest { id }
                        }
                      }
                    }
                    field(name: "Status") {
                      ... on ProjectV2SingleSelectField {
                        id
                        options { id name }
                      }
                    }
                  }
                }
                user(login: $owner) {
                  projectV2(number: $number) {
                    id
                    items(first: 100) {
                      nodes {
                        id
                        content {
                          ... on Issue { id }
                          ... on PullRequest { id }
                        }
                      }
                    }
                    field(name: "Status") {
                      ... on ProjectV2SingleSelectField {
                        id
                        options { id name }
                      }
                    }
                  }
                }
              }
            `;

            const res = await github.graphql(query, { owner, number: projectNumber });
            const project = res.organization?.projectV2 || res.user?.projectV2;
            if (!project) {
              core.setFailed('Projeto não encontrado via GraphQL.');
              return;
            }

            const item = project.items.nodes.find((node) => node.content?.id === contentId);
            if (!item) {
              core.warning('Card não encontrado no projeto (pode ainda não ter sido indexado).');
              return;
            }

            const option = project.field.options.find((opt) => opt.name.toLowerCase() === targetStatus.toLowerCase());
            if (!option) {
              core.setFailed(`Status '${targetStatus}' não encontrado no projeto.`);
              return;
            }

            await github.graphql(`
              mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                updateProjectV2ItemFieldValue(
                  input: {
                    projectId: $projectId,
                    itemId: $itemId,
                    fieldId: $fieldId,
                    value: { singleSelectOptionId: $optionId }
                  }
                ) {
                  projectV2Item { id }
                }
              }
            `, {
              projectId: project.id,
              itemId: item.id,
              fieldId: project.field.id,
              optionId: option.id,
            });

            core.info(`Card movido para '${targetStatus}'.`);
